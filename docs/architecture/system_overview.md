# 音频编解码器硬件加速器系统架构概览

## 1. 系统整体架构

### 1.1 系统框图

```
┌─────────────────────────────────────────────────────────────────┐
│                    Audio Codec Hardware Accelerator            │
├─────────────────────────────────────────────────────────────────┤
│                        Control Interface                       │
│  ┌───────────┐  ┌──────────────┐  ┌─────────────────────────┐   │
│  │    AXI    │  │  Register    │  │    Interrupt            │   │
│  │ Interface │  │    Bank      │  │   Controller            │   │
│  └───────────┘  └──────────────┘  └─────────────────────────┘   │
├─────────────────────────────────────────────────────────────────┤
│                     Data Path Controller                       │
│  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐ │
│  │   Frame Buffer  │  │    Scheduler    │  │   Status & Cfg  │ │
│  │    Manager      │  │   Controller    │  │    Manager      │ │
│  └─────────────────┘  └─────────────────┘  └─────────────────┘ │
├─────────────────────────────────────────────────────────────────┤
│                       Processing Engine                        │
│  ┌─────────────────────────────────────────────────────────────┐ │
│  │                   LC3plus Core                              │ │
│  │  ┌────────────┐ ┌────────────┐ ┌─────────────┐ ┌─────────┐ │ │
│  │  │   Encoder  │ │  Decoder   │ │   MDCT/FFT  │ │  STFT   │ │ │
│  │  │   Engine   │ │   Engine   │ │    Engine   │ │ Engine  │ │ │
│  │  └────────────┘ └────────────┘ └─────────────┘ └─────────┘ │ │
│  └─────────────────────────────────────────────────────────────┘ │
│  ┌─────────────────────────────────────────────────────────────┐ │
│  │                 Common Compute Units                        │ │
│  │  ┌────────────┐ ┌────────────┐ ┌─────────────┐ ┌─────────┐ │ │
│  │  │    DSP     │ │   Memory   │ │   Huffman   │ │  Bit    │ │ │
│  │  │   Array    │ │   Manager  │ │   Codec     │ │ Stream  │ │ │
│  │  └────────────┘ └────────────┘ └─────────────┘ └─────────┘ │ │
│  └─────────────────────────────────────────────────────────────┘ │
├─────────────────────────────────────────────────────────────────┤
│                        Memory Subsystem                        │
│  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐ │
│  │  Input Buffer   │  │  Working Memory │  │  Output Buffer  │ │
│  │     (SRAM)      │  │     (SRAM)      │  │     (SRAM)      │ │
│  └─────────────────┘  └─────────────────┘  └─────────────────┘ │
└─────────────────────────────────────────────────────────────────┘
```

### 1.2 设计原则

1. **模块化设计**: 各编解码器核心独立，便于扩展
2. **流水线架构**: 支持连续帧处理，提高吞吐量
3. **内存优化**: 分层内存架构，减少外部访问
4. **功耗控制**: 动态时钟门控和电源管理
5. **可配置性**: 支持多种采样率和比特率

## 2. LC3plus核心架构

### 2.1 编码器架构

```
输入PCM → 预处理 → MDCT → 量化 → 霍夫曼编码 → 比特流输出
    ↓         ↓       ↓       ↓           ↓
  去直流    窗函数   频域    码表      打包格式
  预加重    重叠     变换    选择      错误检测
```

### 2.2 解码器架构

```
比特流输入 → 霍夫曼解码 → 反量化 → IMDCT → 后处理 → PCM输出
     ↓           ↓         ↓       ↓        ↓
   解包       码表恢复   频域     时域     去预加重
   错误检测   噪声填充   恢复     重叠     直流恢复
```

## 3. 内存架构

### 3.1 内存分配策略

- **输入缓冲**: 2帧容量，支持流水线处理
- **工作内存**: 分块管理，支持多任务
- **输出缓冲**: 2帧容量，减少输出延迟
- **系数存储**: ROM存储固定系数表

### 3.2 内存接口

- **AXI4接口**: 与外部DDR连接
- **内部SRAM**: 高速工作内存
- **DMA控制器**: 自动数据搬移

## 4. 控制接口

### 4.1 总线接口架构

#### 4.1.1 主存储器接口
- **支持总线**: AXI4 / AHB (编译时可选)
- **接口角色**: 音频codec作为Master
- **数据位宽**: 32位
- **功能用途**: 音频数据读写、DMA传输

#### 4.1.2 寄存器配置接口  
- **总线类型**: APB (Advanced Peripheral Bus)
- **接口角色**: 音频codec作为Slave
- **数据位宽**: 32位
- **功能用途**: 配置参数、状态监控、中断管理

### 4.2 寄存器映射 (基于JSON配置)

| 地址 | 寄存器名 | 访问 | 描述 |
|------|----------|------|------|
| 0x0000 | REG_VERSION | RO | 版本信息和ID |
| 0x0004 | REG_FEATURE | RO | 功能特性支持 |
| 0x0008 | REG_CONTROL | RW | 主控制寄存器 |
| 0x000C | REG_STATUS | RO | 状态寄存器 |
| 0x0010 | REG_IRQ_STATUS | RW1C | 中断状态 |
| 0x0014 | REG_IRQ_MASK | RW | 中断屏蔽 |
| 0x0020 | REG_SAMPLE_RATE | RW | 采样率配置 |
| 0x0024 | REG_BITRATE | RW | 比特率配置 |
| 0x0028 | REG_FRAME_LEN | RW | 帧长配置 |
| 0x002C | REG_CHANNELS | RW | 通道配置 |
| 0x0030 | REG_INPUT_ADDR | RW | 输入缓冲地址 |
| 0x0034 | REG_OUTPUT_ADDR | RW | 输出缓冲地址 |
| 0x0038 | REG_BUFFER_SIZE | RW | 缓冲区大小 |
| 0x003C | REG_FRAME_COUNT | RO | 帧计数器 |
| 0x0100+ | REG_DEBUG* | RO | 调试寄存器 |

### 4.3 工作模式

1. **编码模式**: config_mode = 2'b01
2. **解码模式**: config_mode = 2'b10  
3. **空闲模式**: config_mode = 2'b00
4. **自动模式**: 连续处理，中断通知

## 5. 性能指标

### 5.1 目标性能

- **时钟频率**: 100-200 MHz
- **处理延迟**: < 1ms (实时处理)
- **吞吐量**: 支持8通道同时处理
- **功耗**: < 100mW @ 100MHz

### 5.2 资源估算

- **逻辑门数**: ~500K gates
- **内存需求**: ~1MB SRAM
- **DSP单元**: 16个乘法器
- **I/O接口**: AXI4, I2S, UART

## 6. 扩展架构

### 6.1 LC3扩展

- 共享MDCT/FFT引擎
- 独立控制逻辑
- 兼容LC3plus接口

### 6.2 Opus扩展

- 独立CELT/SILK引擎
- 模式切换控制
- 统一输出接口

## 7. 验证架构

### 7.1 验证层次

1. **单元级**: 各功能模块独立验证
2. **子系统级**: 编解码器核心验证
3. **系统级**: 完整系统验证
4. **性能级**: 时序功耗验证

### 7.2 验证方法

- **比特精确验证**: 与参考代码比对
- **随机测试**: 大量随机数据测试
- **边界测试**: 极限参数测试
- **回归测试**: 自动化测试流程 