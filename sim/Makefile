#=============================================================================
# LC3plusç¼–ç å™¨éªŒè¯Makefile (LC3plus Encoder Verification Makefile)
# 
# åŠŸèƒ½ï¼šè‡ªåŠ¨åŒ–LC3plusç¼–ç å™¨çš„å®Œæ•´éªŒè¯æµç¨‹
# ä½œè€…ï¼šAudio Codec Design Team
# ç‰ˆæœ¬ï¼šv1.0
# æ—¥æœŸï¼š2024-06-11
#=============================================================================

# é¡¹ç›®è·¯å¾„é…ç½®
PROJECT_ROOT := $(shell pwd)/..
SIM_DIR := $(PROJECT_ROOT)/sim
RTL_DIR := $(PROJECT_ROOT)/rtl
SCRIPTS_DIR := $(SIM_DIR)/scripts
RESULTS_DIR := $(SIM_DIR)/results
TEST_VECTORS_DIR := $(SIM_DIR)/test_vectors
REFERENCE_DIR := $(SIM_DIR)/reference
TESTBENCH_DIR := $(SIM_DIR)/testbench

# LC3pluså‚è€ƒä»£ç è·¯å¾„
LC3PLUS_REF_DIR := $(PROJECT_ROOT)/LC3plus_ETSI_src_v17171_20200723

# ä»¿çœŸå™¨é…ç½®
SIMULATOR := iverilog
SIMULATOR_FLAGS := -g2012 -Wall
VVP_FLAGS := 
WAVE_FORMAT := vcd

# é¡¶å±‚æ¨¡å—
TOP_MODULE := tb_lc3plus_encoder_top

# RTLæ–‡ä»¶åˆ—è¡¨
RTL_FILES := \
	$(RTL_DIR)/processing/mdct_transform.v \
	$(RTL_DIR)/processing/spectral_analysis.v \
	$(RTL_DIR)/processing/entropy_coding.v \
	$(RTL_DIR)/processing/bitstream_packing.v \
	$(RTL_DIR)/lc3plus_encoder_top.v

# æµ‹è¯•å¹³å°æ–‡ä»¶
TB_FILES := \
	$(TESTBENCH_DIR)/$(TOP_MODULE).sv

# è¾“å‡ºæ–‡ä»¶
SIM_EXECUTABLE := $(RESULTS_DIR)/lc3plus_encoder_sim
VCD_FILE := $(RESULTS_DIR)/simulation.vcd
LOG_FILE := $(RESULTS_DIR)/simulation.log
REPORT_FILE := $(RESULTS_DIR)/verification_report.txt

# Pythonè§£é‡Šå™¨
PYTHON := python3

#=============================================================================
# é»˜è®¤ç›®æ ‡
#=============================================================================

.PHONY: all
all: verify

#=============================================================================
# å¸®åŠ©ä¿¡æ¯
#=============================================================================

.PHONY: help
help:
	@echo "LC3plusç¼–ç å™¨éªŒè¯Makefile"
	@echo ""
	@echo "ä¸»è¦ç›®æ ‡:"
	@echo "  verify           - è¿è¡Œå®Œæ•´éªŒè¯æµç¨‹"
	@echo "  test-vectors     - ç”Ÿæˆæµ‹è¯•å‘é‡"
	@echo "  compile          - ç¼–è¯‘RTLä»£ç "
	@echo "  simulate         - è¿è¡Œä»¿çœŸ"
	@echo "  analyze          - åˆ†æç»“æœ"
	@echo "  report           - ç”ŸæˆæŠ¥å‘Š"
	@echo ""
	@echo "ç»´æŠ¤ç›®æ ‡:"
	@echo "  clean            - æ¸…ç†ç”Ÿæˆæ–‡ä»¶"
	@echo "  clean-all        - æ¸…ç†æ‰€æœ‰æ–‡ä»¶(åŒ…æ‹¬æµ‹è¯•å‘é‡)"
	@echo "  setup            - è®¾ç½®éªŒè¯ç¯å¢ƒ"
	@echo "  check-env        - æ£€æŸ¥ç¯å¢ƒä¾èµ–"
	@echo ""
	@echo "è°ƒè¯•ç›®æ ‡:"
	@echo "  compile-only     - ä»…ç¼–è¯‘ä¸è¿è¡Œ"
	@echo "  quick-sim        - å¿«é€Ÿä»¿çœŸ(è·³è¿‡æµ‹è¯•å‘é‡ç”Ÿæˆ)"
	@echo "  view-waves       - æŸ¥çœ‹æ³¢å½¢æ–‡ä»¶"
	@echo ""
	@echo "é…ç½®å˜é‡:"
	@echo "  SIMULATOR=$(SIMULATOR)"
	@echo "  TOP_MODULE=$(TOP_MODULE)"
	@echo "  WAVE_FORMAT=$(WAVE_FORMAT)"

#=============================================================================
# ç¯å¢ƒæ£€æŸ¥
#=============================================================================

.PHONY: check-env
check-env:
	@echo "æ£€æŸ¥éªŒè¯ç¯å¢ƒ..."
	@which $(SIMULATOR) > /dev/null || (echo "é”™è¯¯: æ‰¾ä¸åˆ°ä»¿çœŸå™¨ $(SIMULATOR)" && exit 1)
	@which $(PYTHON) > /dev/null || (echo "é”™è¯¯: æ‰¾ä¸åˆ°Pythonè§£é‡Šå™¨" && exit 1)
	@test -d $(LC3PLUS_REF_DIR) || (echo "é”™è¯¯: æ‰¾ä¸åˆ°LC3pluså‚è€ƒä»£ç ç›®å½•" && exit 1)
	@echo "ç¯å¢ƒæ£€æŸ¥é€šè¿‡"

#=============================================================================
# è®¾ç½®éªŒè¯ç¯å¢ƒ
#=============================================================================

.PHONY: setup
setup: check-env
	@echo "è®¾ç½®éªŒè¯ç¯å¢ƒ..."
	@mkdir -p $(RESULTS_DIR)
	@mkdir -p $(TEST_VECTORS_DIR)
	@mkdir -p $(REFERENCE_DIR)
	@echo "éªŒè¯ç¯å¢ƒè®¾ç½®å®Œæˆ"

#=============================================================================
# æµ‹è¯•å‘é‡ç”Ÿæˆ
#=============================================================================

$(TEST_VECTORS_DIR)/.vectors_generated: setup
	@echo "ç”Ÿæˆæµ‹è¯•å‘é‡..."
	@cd $(SCRIPTS_DIR) && $(PYTHON) generate_test_vectors.py
	@touch $@

.PHONY: test-vectors
test-vectors: $(TEST_VECTORS_DIR)/.vectors_generated

#=============================================================================
# RTLç¼–è¯‘
#=============================================================================

$(SIM_EXECUTABLE): $(RTL_FILES) $(TB_FILES) setup
	@echo "ç¼–è¯‘RTLä»£ç ..."
	@echo "  ä»¿çœŸå™¨: $(SIMULATOR)"
	@echo "  é¡¶å±‚æ¨¡å—: $(TOP_MODULE)"
	@echo "  RTLæ–‡ä»¶: $(words $(RTL_FILES)) ä¸ª"
	$(SIMULATOR) $(SIMULATOR_FLAGS) -o $@ $(TB_FILES) $(RTL_FILES)
	@echo "RTLç¼–è¯‘å®Œæˆ"

.PHONY: compile
compile: $(SIM_EXECUTABLE)

.PHONY: compile-only
compile-only: compile

#=============================================================================
# ä»¿çœŸè¿è¡Œ
#=============================================================================

$(LOG_FILE): $(SIM_EXECUTABLE) test-vectors
	@echo "è¿è¡Œä»¿çœŸ..."
	@echo "  å¯æ‰§è¡Œæ–‡ä»¶: $(SIM_EXECUTABLE)"
	@echo "  æ—¥å¿—æ–‡ä»¶: $(LOG_FILE)"
ifeq ($(SIMULATOR),iverilog)
	@cd $(RESULTS_DIR) && vvp $(VVP_FLAGS) $(SIM_EXECUTABLE) | tee $(LOG_FILE)
else
	@echo "æš‚ä¸æ”¯æŒä»¿çœŸå™¨: $(SIMULATOR)"
	@exit 1
endif
	@echo "ä»¿çœŸå®Œæˆ"

.PHONY: simulate
simulate: $(LOG_FILE)

.PHONY: quick-sim
quick-sim: $(SIM_EXECUTABLE)
	@echo "å¿«é€Ÿä»¿çœŸ(è·³è¿‡æµ‹è¯•å‘é‡ç”Ÿæˆ)..."
	@cd $(RESULTS_DIR) && vvp $(VVP_FLAGS) $(SIM_EXECUTABLE) | tee $(LOG_FILE)

#=============================================================================
# ç»“æœåˆ†æ
#=============================================================================

.PHONY: analyze
analyze: $(LOG_FILE)
	@echo "åˆ†æä»¿çœŸç»“æœ..."
	@cd $(SCRIPTS_DIR) && $(PYTHON) -c "\
import sys; \
sys.path.append('.'); \
from run_verification import LC3plusVerificationRunner; \
runner = LC3plusVerificationRunner(); \
results = runner.analyze_simulation_log('$(LOG_FILE)'); \
print(f'é€šè¿‡ç‡: {results[\"pass_rate\"]:.1f}%'); \
print(f'æ€»å¸§æ•°: {results[\"total_frames\"]}'); \
print(f'é€šè¿‡å¸§æ•°: {results[\"passed_frames\"]}'); \
print(f'å¤±è´¥å¸§æ•°: {results[\"failed_frames\"]}'); \
"

#=============================================================================
# æŠ¥å‘Šç”Ÿæˆ
#=============================================================================

$(REPORT_FILE): $(LOG_FILE)
	@echo "ç”ŸæˆéªŒè¯æŠ¥å‘Š..."
	@cd $(SCRIPTS_DIR) && $(PYTHON) run_verification.py --steps generate_report
	@echo "éªŒè¯æŠ¥å‘Šç”Ÿæˆå®Œæˆ: $(REPORT_FILE)"

.PHONY: report
report: $(REPORT_FILE)

#=============================================================================
# å®Œæ•´éªŒè¯æµç¨‹
#=============================================================================

.PHONY: verify
verify: setup test-vectors compile simulate analyze report
	@echo ""
	@echo "=== LC3plusç¼–ç å™¨éªŒè¯å®Œæˆ ==="
	@echo ""
	@if grep -q "éªŒè¯é€šè¿‡" $(REPORT_FILE); then \
		echo "ğŸ‰ éªŒè¯ç»“æœ: é€šè¿‡"; \
		echo "è¯¦ç»†æŠ¥å‘Šè¯·æŸ¥çœ‹: $(REPORT_FILE)"; \
	else \
		echo "âŒ éªŒè¯ç»“æœ: å¤±è´¥"; \
		echo "è¯·æ£€æŸ¥æ—¥å¿—: $(LOG_FILE)"; \
		echo "è¯¦ç»†æŠ¥å‘Š: $(REPORT_FILE)"; \
		exit 1; \
	fi

#=============================================================================
# å®Œæ•´è‡ªåŠ¨åŒ–éªŒè¯(ä½¿ç”¨Pythonè„šæœ¬)
#=============================================================================

.PHONY: auto-verify
auto-verify: setup
	@echo "è¿è¡Œè‡ªåŠ¨åŒ–éªŒè¯æµç¨‹..."
	@cd $(SCRIPTS_DIR) && $(PYTHON) run_verification.py
	@echo "è‡ªåŠ¨åŒ–éªŒè¯å®Œæˆ"

#=============================================================================
# æ³¢å½¢æŸ¥çœ‹
#=============================================================================

.PHONY: view-waves
view-waves:
	@if [ -f $(VCD_FILE) ]; then \
		echo "æŸ¥çœ‹æ³¢å½¢æ–‡ä»¶: $(VCD_FILE)"; \
		if which gtkwave > /dev/null 2>&1; then \
			gtkwave $(VCD_FILE) &; \
		else \
			echo "è¯·å®‰è£…GTKWaveæŸ¥çœ‹æ³¢å½¢æ–‡ä»¶"; \
		fi; \
	else \
		echo "æ³¢å½¢æ–‡ä»¶ä¸å­˜åœ¨: $(VCD_FILE)"; \
		echo "è¯·å…ˆè¿è¡Œä»¿çœŸç”Ÿæˆæ³¢å½¢"; \
	fi

#=============================================================================
# æ¸…ç†ç›®æ ‡
#=============================================================================

.PHONY: clean
clean:
	@echo "æ¸…ç†ç”Ÿæˆæ–‡ä»¶..."
	@rm -f $(SIM_EXECUTABLE)
	@rm -f $(VCD_FILE)
	@rm -f $(LOG_FILE)
	@rm -f $(REPORT_FILE)
	@rm -f $(RESULTS_DIR)/*.json
	@rm -f $(RESULTS_DIR)/simulation
	@echo "æ¸…ç†å®Œæˆ"

.PHONY: clean-vectors
clean-vectors:
	@echo "æ¸…ç†æµ‹è¯•å‘é‡..."
	@rm -rf $(TEST_VECTORS_DIR)/*
	@rm -rf $(REFERENCE_DIR)/*
	@echo "æµ‹è¯•å‘é‡æ¸…ç†å®Œæˆ"

.PHONY: clean-all
clean-all: clean clean-vectors
	@echo "æ¸…ç†æ‰€æœ‰ç”Ÿæˆæ–‡ä»¶..."
	@rm -rf $(RESULTS_DIR)
	@echo "å…¨éƒ¨æ¸…ç†å®Œæˆ"

#=============================================================================
# è°ƒè¯•å’Œå¼€å‘ç›®æ ‡
#=============================================================================

.PHONY: debug-compile
debug-compile:
	@echo "è°ƒè¯•æ¨¡å¼ç¼–è¯‘..."
	$(SIMULATOR) $(SIMULATOR_FLAGS) -DDEBUG -o $(SIM_EXECUTABLE) $(TB_FILES) $(RTL_FILES)

.PHONY: lint
lint:
	@echo "RTLä»£ç æ£€æŸ¥..."
	@for file in $(RTL_FILES); do \
		echo "æ£€æŸ¥: $$file"; \
		verilator --lint-only -Wall $$file || true; \
	done

.PHONY: info
info:
	@echo "é¡¹ç›®ä¿¡æ¯:"
	@echo "  é¡¹ç›®æ ¹ç›®å½•: $(PROJECT_ROOT)"
	@echo "  RTLç›®å½•: $(RTL_DIR)"
	@echo "  ä»¿çœŸç›®å½•: $(SIM_DIR)"
	@echo "  ç»“æœç›®å½•: $(RESULTS_DIR)"
	@echo "  RTLæ–‡ä»¶æ•°: $(words $(RTL_FILES))"
	@echo "  é¡¶å±‚æ¨¡å—: $(TOP_MODULE)"
	@echo "  ä»¿çœŸå™¨: $(SIMULATOR)"

#=============================================================================
# æ‰¹é‡æµ‹è¯•ç›®æ ‡
#=============================================================================

.PHONY: test-config-%
test-config-%:
	@echo "æµ‹è¯•é…ç½®: $*"
	@cd $(SCRIPTS_DIR) && $(PYTHON) run_verification.py --config $*

.PHONY: regression
regression:
	@echo "è¿è¡Œå›å½’æµ‹è¯•..."
	@for config in 16k_mono 24k_mono 48k_mono 48k_stereo; do \
		$(MAKE) test-config-$$config || exit 1; \
	done
	@echo "å›å½’æµ‹è¯•å®Œæˆ"

#=============================================================================
# æŒç»­é›†æˆç›®æ ‡
#=============================================================================

.PHONY: ci-verify
ci-verify: check-env clean-all verify
	@echo "CIéªŒè¯å®Œæˆ"

.PHONY: ci-quick
ci-quick: check-env clean compile quick-sim
	@echo "CIå¿«é€ŸéªŒè¯å®Œæˆ"

#=============================================================================
# æ–‡æ¡£ç”Ÿæˆ
#=============================================================================

.PHONY: docs
docs:
	@echo "ç”Ÿæˆæ–‡æ¡£..."
	@echo "æš‚æœªå®ç°æ–‡æ¡£ç”ŸæˆåŠŸèƒ½"

#=============================================================================
# æ–‡ä»¶ç›‘å¬
#=============================================================================

# æ£€æŸ¥æ–‡ä»¶å˜åŒ–å¹¶é‡æ–°ç¼–è¯‘çš„ç›®æ ‡
.PHONY: watch
watch:
	@echo "ç›‘å¬æ–‡ä»¶å˜åŒ–..."
	@echo "ä½¿ç”¨Ctrl+Cåœæ­¢ç›‘å¬"
	@while true; do \
		inotifywait -e modify $(RTL_FILES) $(TB_FILES) 2>/dev/null && \
		echo "æ£€æµ‹åˆ°æ–‡ä»¶å˜åŒ–ï¼Œé‡æ–°ç¼–è¯‘..." && \
		$(MAKE) compile; \
	done

#=============================================================================
# ç‰¹æ®Šç›®æ ‡å£°æ˜
#=============================================================================

# é¿å…ä¸æ–‡ä»¶åå†²çª
.PHONY: all help verify test-vectors compile simulate analyze report clean

# ä¿æŒä¸­é—´æ–‡ä»¶
.PRECIOUS: $(SIM_EXECUTABLE) $(LOG_FILE) $(VCD_FILE)

# é»˜è®¤shell
SHELL := /bin/bash 